---
title: "Prepare Response Data for DrugComb"
author: "Shuyu Zheng"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{"Prepare Response Data for DrugComb"}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

# Input Data
Let's start to data preparing with a "template" table which was provided by users or generated by yourself according to some public drug combination data. We provide an example in our package for reference:
```{r}
template <- read.csv(system.file("extdata", "template.csv",
                                 package = "TidyComb"),
                     stringsAsFactors = FALSE)
head(template)
```

# 1. Prepare cell line information
```{r message=FALSE, warning=FALSE}
library("dplyr")
library("TidyComb")
```

## 1.1 Generating 'cell_line', 'tissue', 'disease' and index table 'cell_id'.

## 1.1 Get a correct matching table for cell_line_name and cellosaurus_accession.
```{r}
cells <- unique(na.omit(template$cell_line_name))
cell.match <- MatchCellAcc(cells)
print(cell.match)
```

**Note**: At this step, manually check the matched table and make sure we use the correct cellosaurus accession for further process. Searching conflict cell lines on [ExpasyCellosaurus](https://web.expasy.org/cellosaurus)web page may be helpful.

In this case, cell line _U87_ was matched with two different records. We pick the first one (from "ATCC" company) and generate a "cell.accession" index table for further data processing.

```{r}
cell.match.clean <- cell.match[-2, c("input_name", "cellosaurus_accession")]
```

## 1.2 Generate files according to cellosaurus accessions.

```{r}
cell <- GenerateCell(cell.accession$cellosaurus_accession)
names(cell)

```


`GenerateCell()` function generates 4 data frames:
* `cell_line`: the **cell_line** table ready for uploading to DrugComb.
* `tissue`: the **tissue** table ready for uploading to DrugComb.
* `disease`: the **disease** table ready for uploading to DrugComb.
* `cell_id`: an index table for matching drug `cell_line_id` with `cellosaurus accession`.

## 1.3 Generate "cell_line_id" column in "template" 
Output list from section _1.1.2_ contains another table `cell_id`. Let's use it to generate the `cell_line_id` for `template`.
```{r}
cell.index <- cell.match.clean %>% 
  left_join(cell$cell_id, by = "cellosaurus_accession") %>% 
  select(input_name, id)
template$cell_line_id <- cell.index$id[match(template$cell_line_name,
                                                cell.index$input_name)]
names(template)
```
  
# 2. Prepare Drug information

## 2.1 Get correct CIDs for drug

```{r}
cids <- na.omit(unique(c(template$drug_row_cid, template$drug_col_cid)))
```

**Note**: In this example "template" file, we already recorded CIDs of drugs in columns `drug_row_cid` and `drug_col_cid`. However, sometimes we can not get CIDs directly from user or public data. In these cases, we provide function `GetCid()` in our package to facilates matching CID from other identifiers.

## 2.2 Generating "drug" file
```{r}
drug <- GenerateDrug(cids)
names(drug)
```

`GenerateDrug()` function generates data frames:
* `drug`: the **drug** table ready for uploading to DrugComb.
* `drug.id`: an index table for matching drug `drug_id` with `cid`.

## 2.3 add "drug_id" to "template"
```{r}
drug_index <- drug$drug.id
template$drug_row_id <- drug_index$id[match(template$drug_row_cid,
                                            drug_index$cid)]
template$drug_col_id <- drug_index$id[match(template$drug_col_cid,
                                            drug_index$cid)]
head(template)
```

# 3. calculate synergy scores and generate other files for uploading

```{r warning=FALSE}
tables <- pipeline(template)
names(tables)
```

`pipeline` function generates 5 data frames:
* `response_with_score`: a table containing calculated synergy scores of each interaction block.
* `response`: the **response** table ready for uploading to DrugComb.
* `summary`: the **summary** table ready for uploading to DrugComb.
* `surface`: the **curface** table ready for uploading to DrugComb.
* `curve`: the **curve** table ready for uploading to DrugComb.

# Output and check data

```{r}
write.csv(cell$cell_line, "cell_line.csv", row.names = FALSE)
write.csv(cell$tissue, "tissue.csv", row.names = FALSE)
write.csv(cell$disease, "disease.csv", row.names = FALSE)
write.csv(drug$drug, "drug.csv", row.names = FALSE)
write.csv(tables$response, "response.csv", row.names = FALSE)
write.csv(tables$summary, "summary.csv", row.names = FALSE)
write.csv(tables$surface, "surface.csv", row.names = FALSE)
write.csv(tables$curve, "curve.csv", row.names = FALSE)
```

(More details about required information is listed in [About_Data](/About_Data))

## 1.2. Preparing 'drug' document
**R script**: 2.drug.R

1. Extract the drug information from raw data. (names, ids or anything accessible) More details can be found in [Study specific processing](/Study_specific_processing)

2. Get CID from PubChem, according to the information from _step 1_ via [PUG REST](https://pubchemdocs.ncbi.nlm.nih.gov/pug-rest). [[2](#pubchem)] Some manual work needed if the output CID is absent or not unique for some drugs.
3. 'Chem_id' and maximum clinical trial Phase of each compound were collected via [ChEMBL Web Services](https://www.ebi.ac.uk/chembl/ws). [[3](#chembl)]
3. Check the CID list with the drugs in current DrugComb database.
    * For drugs already in DrugComb, extract their 'drug_name' and 'drug_id' from the database into a new table named 'drug_id_index'.
    * For drugs absent in DrugComb:
        1. Retrieve drug information of _new drugs_ via [PUG REST](https://pubchemdocs.ncbi.nlm.nih.gov/pug-rest)(Note: extract the first name in 'synonym' as the 'drug_name')
        2. Assign a unique 'drug_id' to each _new drugs_.
        3. Append the 'drug_name' and 'drug_id' into 'drug_id_index' table. Write it into file **'drug_id_index.csv'**.
        4. Write information about _new drugs_ to **'drug.csv'** and save it in 'Upload' folder.

## 1.3. Preparing 'response_raw' document
**R script**: 3.response_raw.R

'response_raw' document contains the necessary information required for generating synergy estimation data tables, including the final version of 'response', 'curve', 'summary', 'curve', 'surface'

The 'response_raw' document should contain the columns: 'block_id', 'conc_r', 'conc_c', 'response', 'drug_row', 'drug_col', 'cell_name','cell_line_id', 'drug_row_id', 'drug_col_id', 'conc_r_unit', 'conc_c_unit'

1. Extract the response data from raw data.
2. Check the method used in the study to see if the raw 'response' value consists with those in DrugComb. If not, adjust them DrugComb database required values. More details could be found in [Study specific processing](/Study_specific_processing).
3. Match 'drug_row' and 'drug_col' with the 'drug_id' using 'drug_id_index.csv' table .
4. Create a unique 'block_id' for each drug-drug interaction block.
5. Add 'block_id' in the 'study' table. Duplicate the records in other columns to fit the length of 'block_id'. Write it into **'study.csv'** and saved in 'Upload' folder.

# 2. Calculation for DrugComb required data
## 2.1. 'response.csv'
**R script**: 4. calculate.R

1. Input 'response_raw' table into the workspace for further calculation.
2. Creating columns 'row' and 'col' according to the rank of 'conc_r' and 'conc_r', respectively.
3. Calculate the synergy scores (ZIP, HSA, Bliss, Loewe) of _each row_ in according to the 'response' using 'xxxx' R package.
4. Trim the response table according to [schema](https://www.dropbox.com/sh/l77yp1gs6tpkapr/AAAqfJfwhJ_UYLpsKcEigoGWa?dl=0&preview=schema.png) and output it as **'response.csv'** in 'Upload' folder for upload.
5. Output the results as **'response.csv'** in the working directory for further calculation.

## 2.2. 'summary.csv'
**R script**:

## 2.3. 'curve.csv'
**R script**:

## 2.4. 'surface.csv'
**R script**:

# 3. Check files before the upload
**R script**: 

Now we have put all files required for DrugComb in 'Upload' folder. Before submitting to database, the following checks are needed:

1. Whether content of each file is consistent with [schema](https://www.dropbox.com/sh/l77yp1gs6tpkapr/AAAqfJfwhJ_UYLpsKcEigoGWa?dl=0&preview=schema.png)?
2. Whether the drugs in **'response.csv'** either in **'drug.csv'** or current DrugComb database?
3. Whether the **'drug_name'** and **'drug_id'** could be matched among **'response.csv'**, **'surface.csv'** and **'drug.csv'**?

---
# Reference
[1](#cellosaurus). Bairoch, A. (2018). The Cellosaurus, a Cell-Line Knowledge Resource. J Biomol Tech 29, 25–38.
[2](#pubchem). Kim, S., Thiessen, P.A., Bolton, E.E., Chen, J., Fu, G., Gindulyte, A., Han, L., He, J., He, S., Shoemaker, B.A., et al. (2016). PubChem Substance and Compound databases. Nucleic Acids Res 44, D1202–D1213.
[3](#chembl). Davies, M., Nowotka, M., Papadatos, G., Dedman, N., Gaulton, A., Atkinson, F., Bellis, L., and Overington, J.P. (2015). ChEMBL web services: streamlining access to drug discovery data and utilities. Nucleic Acids Res 43, W612–W620.